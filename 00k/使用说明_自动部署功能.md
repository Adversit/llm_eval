# FLMM评估系统 - 自动部署功能使用说明

## 🎯 功能概述

本系统现已支持**自动启动Streamlit服务并生成访问链接**，无需手动运行问卷页面！

### 核心特性
✅ 创建评估项目时自动启动Streamlit服务
✅ 自动分配可用端口(从8502开始)
✅ 生成可直接访问的URL链接
✅ 提供服务管理界面，查看和停止服务
✅ 支持问卷填写和证明材料上传两种服务类型

---

## 📋 使用流程

### 1. 启动主平台

```bash
conda activate damoxingeval
cd D:\work\project\LLM_eval
streamlit run 00k/app.py
```

访问: `http://localhost:8501`

### 2. 创建评估项目

在主平台中:

1. **选择"问卷创建管理"模块**
2. **填写基本信息**
   - 公司名称: 例如 `中金公司`
   - 场景名称: 例如 `投研大模型`
   - 场景描述: 详细描述业务场景
   - 功能模块: 添加具体功能(如"信息问答")

3. **选择问卷内容**
   - 从FLMM调研表中选择能力项
   - 支持按能力域、子域、具体能力项选择

4. **选择证明材料**(可选)
   - 从FLMM自评表中选择需要收集材料的能力项

5. **预览并生成**
   - 查看选择的内容
   - 配置功能开关(问卷收集/证明材料收集)
   - 点击"确认生成项目"

### 3. 获取访问信息

生成成功后,系统会显示:

```
✅ 评估项目创建成功！

已生成以下文件：
- 项目文件夹：data/中金公司_投研大模型/
- 📄 项目信息：中金公司_投研大模型.json
- 📊 问卷文件：中金公司_投研大模型_问卷.xlsx
- 💻 问卷采集页面：中金公司_投研大模型.py

被评估方登录信息：
- 用户名：user_中金公司_eea058d3
- 密码：17ec2e12-90c

📋 问卷填写链接（已自动启动）：
- 🔗 访问地址：http://localhost:8502
- ⏰ 服务已在后台运行，请等待5-10秒后访问
- 💡 提示：使用上述账号密码登录即可填写问卷
```

### 4. 访问问卷填写页面

1. **等待5-10秒**让Streamlit服务完全启动
2. **复制访问地址**并在浏览器中打开
3. **使用提供的账号密码登录**
4. **填写问卷**并提交

---

## 🔧 服务管理

### 查看运行中的服务

在主平台中选择**"服务管理"**模块:

- 📊 **服务列表**: 显示所有已启动的服务
- 🟢 **运行状态**: 实时检测服务是否在运行
- 🔗 **访问链接**: 直接点击链接访问服务
- 📈 **统计信息**: 总服务数、运行中、已停止

### 服务操作

**单个服务操作**:
- `🛑 停止`: 停止正在运行的服务
- `🗑️ 移除`: 从列表中移除已停止的服务

**批量操作**:
- `🛑 停止所有服务`: 一键停止所有运行中的服务
- `🗑️ 清理已停止服务`: 清理配置文件中已停止的服务记录

---

## 🗂️ 端口管理

### 端口分配规则

- **起始端口**: 8502
- **分配方式**: 自动查找可用端口
- **最大尝试**: 100个端口(8502-8601)
- **主平台端口**: 8501(手动指定,不占用自动分配范围)

### 端口配置文件

位置: `data/.port_config.json`

内容示例:
```json
{
  "中金公司_投研大模型_questionnaire": {
    "port": 8502,
    "pid": 12345,
    "file": "中金公司_投研大模型.py",
    "type": "questionnaire"
  },
  "中金公司_投研大模型_evidence": {
    "port": 8503,
    "pid": 12346,
    "file": "中金公司_投研大模型_证明材料.py",
    "type": "evidence"
  }
}
```

---

## 🔍 技术实现细节

### 自动启动流程

1. **生成项目文件** → 创建文件夹、JSON、Excel、Python文件
2. **查找可用端口** → 使用socket检测端口可用性
3. **启动Streamlit进程** → 后台运行`streamlit run`命令
4. **保存配置信息** → 记录端口、PID、文件名到配置文件
5. **返回访问链接** → 生成http://localhost:端口 URL

### 进程管理

使用Python的`subprocess`和`psutil`库:
- **启动**: `subprocess.Popen()` 后台运行
- **检测**: `psutil.Process(pid).is_running()` 检查进程状态
- **停止**: `process.terminate()` 优雅关闭,失败则`kill()`

---

## 📝 注意事项

### 1. 等待时间
⚠️ Streamlit服务启动需要5-10秒,请耐心等待后再访问链接

### 2. 端口冲突
如果提示端口被占用:
- 系统会自动尝试下一个可用端口
- 可以在服务管理中查看实际分配的端口

### 3. 防火墙设置
确保本地防火墙允许访问8501-8601端口范围

### 4. 进程清理
- 关闭主平台不会自动停止已启动的问卷服务
- 需要在"服务管理"中手动停止
- 或在任务管理器中结束streamlit进程

### 5. 并发限制
理论上可同时运行100个服务(端口范围限制)
实际建议不超过10个服务同时运行

---

## 🐛 故障排查

### 问题1: 访问链接显示"无法连接"

**原因**: 服务未完全启动
**解决**: 等待10-15秒后刷新页面

### 问题2: 登录后显示"加载失败"

**原因**: 工作目录不正确,无法找到Excel文件
**解决**:
- 检查生成的.py文件位置
- 确保问卷.xlsx文件在同一目录

### 问题3: 服务显示"已停止"但端口被占用

**原因**: 进程异常退出但未释放端口
**解决**:
```bash
# 查找占用端口的进程
netstat -ano | findstr "8502"

# 结束进程(PID替换为实际值)
taskkill /PID 12345 /F
```

### 问题4: 创建项目后没有自动启动

**原因**: Streamlit命令未在PATH中
**解决**:
```bash
# 确认Streamlit可用
conda activate damoxingeval
streamlit --version

# 如果不可用,重新安装
pip install streamlit
```

---

## 🔄 升级内容

### 相比手动运行的改进

**之前的方式**:
```bash
# 需要手动进入目录
cd data/中金公司_投研大模型

# 手动运行
streamlit run 中金公司_投研大模型.py --server.port 8502
```

**现在的方式**:
- ✅ 自动启动,无需手动操作
- ✅ 自动分配端口,无需指定
- ✅ 提供访问链接,直接复制使用
- ✅ 统一管理,可视化查看所有服务

---

## 📞 技术支持

如有问题,请检查:
1. 虚拟环境是否正确激活(`damoxingeval`)
2. Streamlit是否已安装(`streamlit --version`)
3. 端口是否被占用(`netstat -ano | findstr "端口号"`)
4. 配置文件是否正常(`data/.port_config.json`)

---

## 🎉 后续计划

- [ ] 支持自定义端口范围
- [ ] 添加服务健康检查
- [ ] 支持服务重启功能
- [ ] 添加日志查看功能
- [ ] 支持远程访问(非localhost)
