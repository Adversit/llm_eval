 一、系统整体架构

  这是一个基于 Streamlit 的 FLMM(金融大模型应用能力评估框架) 问卷管理平台,采用模块化设计,主要包含:

  00k/
  ├── app.py                          # 主入口(使用统一UI风格)
  ├── model_config.json               # LLM配置
  ├── requirements.txt                # 依赖
  ├── data_parser.py                  # 数据解析核心模块
  ├── function/                       # 功能模块
  │   ├── Admin_create_function_page.py    # 问卷创建管理
  │   ├── Admin_analyse_function_page.py   # 问卷结果分析
  │   └── llm_service.py              # LLM服务
  └── data/                           # 数据目录
      ├── FLMM调研表.xlsx            # 问卷题库(5列)
      ├── FLMM自评表.xlsx            # 证明材料题库(4列)
      └── [项目文件夹]/              # 生成的评估项目

  ---
  二、核心子模块功能说明

  1. data_parser.py - 数据解析模块

  作用: 解析Excel数据,构建层级结构

  核心函数:
  - parse_flmm_data() - 解析FLMM调研表(5列:能力域→子域1→子域2→能力项→调研问题)
  - parse_flmm_evaluation_table() - 解析FLMM自评表(4列:能力域→子域1→子域2→能力项)
  - build_comprehensive_structure() - 构建问卷题库树形结构
  - build_flmm_evaluation_structure() - 构建证明材料题库树形结构
  - parse_question_content() - 解析问题文本,提取选项和替换占位符({name})

  2. Admin_create_function_page.py - 问卷创建模块

  作用: 4步流程创建评估项目

  4个页面:
  1. show_company_info() - 输入公司信息、场景、功能模块
  2. show_questionnaire_selection() - 选择问卷内容(从FLMM调研表)
  3. show_evidence_selection() - 选择证明材料项(从FLMM自评表)
  4. show_final_preview() - 预览并生成项目

  生成内容:
  - 项目JSON文件 - 包含评估信息和账号信息
  - 问卷Excel - 按选择的能力项生成问卷(带选项列)
  - 问卷采集页面.py - 动态生成的Streamlit页面(带登录)
  - 证明材料采集页面.py - 文件上传页面(支持单/多文件/ZIP)
  - 证明材料文件夹 - 按能力项分类的文件夹结构

  3. Admin_analyse_function_page.py - 问卷分析模块

  作用: 分析问卷结果,生成可视化报告

  分析功能:
  - 单选题/多选题统计(Plotly图表)
  - 能力项分布图
  - 5个评级维度(基于期望值计算):
    a. 用户需求匹配度
    b. 业务自动化提升率
    c. 业务决策支持力
    d. 客户忠诚度
    e. 时间成本节约率
  - AI分析报告(调用LLM生成多选题洞察)

  4. llm_service.py - LLM服务模块

  作用: 调用外部大模型API

  功能:
  - load_llm_config() - 加载model_config.json
  - get_llm_analysis() - 同步调用大模型
  - get_llm_analysis_stream() - 流式调用大模型(用于报告生成)

  ---
  三、问卷系统详细说明

  🎯 问卷是如何生成的?

  生成流程:
  1. 管理员操作:在 Admin_create_function_page 中选择能力项
  2. Excel生成: generate_project() 函数从FLMM调研表提取对应问题
  3. 动态页面生成: generate_questionnaire_page_code() 生成完整的Streamlit代码
    - 包含登录验证
    - 问卷展示逻辑
    - 答案收集和保存

  示例生成文件:
  # 生成的问卷页面包含:
  - 登录验证(基于JSON中的账号密码)
  - 问题展示(单选/多选)
  - 答案收集(转换为字母格式A/B/C)
  - 结果保存(Excel + JSON)

  📊 问卷是如何使用的?

  使用场景: 给被评估方(如金融机构)使用

  使用流程:
  1. 管理员:创建评估项目,生成问卷和账号
  2. 被评估方:收到账号密码和问卷链接
  3. 填写问卷:登录后逐题回答
  4. 提交结果:系统保存为Excel和JSON
  5. 管理员分析:使用分析页面生成报告

  技术实现:
  # 生成的问卷页面(中金公司_投研大模型.py):
  streamlit run data/中金公司_投研大模型/中金公司_投研大模型.py

  # 特点:
  - 独立运行的Streamlit应用
  - 内置登录保护
  - 答案保存到同目录下
  - 支持断点续答(session_state)

  🔐 用户角色分离

  | 角色   | 使用界面                 | 功能             |
  |------|----------------------|----------------|
  | 管理员  | app.py (主平台)         | 创建问卷、选择题目、分析结果 |
  | 被评估方 | [公司]_[场景].py (生成的页面) | 登录、填写问卷、提交答案   |

  ---
  四、前端集成方案

  方案1: Streamlit原生部署(当前方案)

  优点:
  - 开箱即用,无需额外开发
  - 适合快速原型和内部工具

  部署:
  # 主平台(管理员)
  streamlit run 00k/app.py --server.port 8501

  # 生成的问卷(被评估方)
  cd data/中金公司_投研大模型
  streamlit run 中金公司_投研大模型.py --server.port 8502

  访问:
  - 管理员: http://localhost:8501
  - 被评估方: http://localhost:8502

  ---
  方案2: API化 + 前后端分离(推荐生产环境)

  架构:
  前端(React/Vue)  <-->  后端API(FastAPI)  <-->  Streamlit组件(可选)
                            ↓
                        数据层(Excel/DB)

  实现步骤:

  1. 后端API开发(FastAPI)
  # api.py
  from fastapi import FastAPI, HTTPException
  from data_parser import build_comprehensive_structure
  import json

  app = FastAPI()

  @app.get("/api/questionnaire/structure")
  def get_structure():
      """获取问卷题库结构"""
      return build_comprehensive_structure()

  @app.post("/api/questionnaire/create")
  def create_project(data: dict):
      """创建评估项目"""
      # 调用generate_project()
      return {"project_id": "xxx", "login_url": "..."}

  @app.post("/api/questionnaire/submit")
  def submit_answers(answers: list):
      """提交问卷答案"""
      # 保存到Excel/DB
      return {"status": "success"}

  @app.get("/api/analysis/{project_id}")
  def get_analysis(project_id: str):
      """获取分析结果"""
      # 调用Admin_analyse_function_page的逻辑
      return {"charts": [...], "ratings": {...}}

  2. 前端集成(React示例)
  // 问卷创建
  function CreateQuestionnaire() {
    const [structure, setStructure] = useState({});

    useEffect(() => {
      fetch('/api/questionnaire/structure')
        .then(res => res.json())
        .then(setStructure);
    }, []);

    return (
      <div>
        {/* 树形选择器 */}
        <TreeSelect data={structure} onChange={handleSelect} />
        <Button onClick={createProject}>生成问卷</Button>
      </div>
    );
  }

  // 问卷填写
  function FillQuestionnaire() {
    const [questions, setQuestions] = useState([]);
    const [answers, setAnswers] = useState({});

    return (
      <form onSubmit={submitAnswers}>
        {questions.map(q => (
          <Question key={q.id} {...q} onChange={updateAnswer} />
        ))}
        <Button type="submit">提交</Button>
      </form>
    );
  }

  3. 图表组件(使用Plotly/ECharts)
  import Plot from 'react-plotly.js';

  function AnalysisChart({ data }) {
    return (
      <Plot
        data={data.charts}
        layout={{title: '用户需求匹配度'}}
      />
    );
  }

  ---
  方案3: 嵌入式集成(iframe)

  优点: 快速集成,保留Streamlit功能

  实现:
  <!-- 管理后台 -->
  <iframe src="http://streamlit-server:8501" width="100%" height="800px"></iframe>

  <!-- 问卷页面 -->
  <iframe src="http://streamlit-server:8502/?questionnaire_id=xxx" width="100%" height="800px"></iframe>

  注意事项:
  - 需要配置CORS
  - Streamlit需要设置 server.enableCORS=true
  - 使用 st.query_params 传递参数

  ---
  方案4: 渐进式迁移(推荐)

  步骤:
  1. Phase 1: 保留Streamlit,通过API暴露核心功能
  2. Phase 2: 前端实现关键页面(创建、分析)
  3. Phase 3: 完全迁移到前后端分离

  示例代码:
  # 在现有代码基础上添加API层
  from fastapi import FastAPI
  from fastapi.middleware.cors import CORSMiddleware

  api_app = FastAPI()
  api_app.add_middleware(CORSMiddleware, allow_origins=["*"])

  # 复用现有函数
  from function.Admin_create_function_page import generate_project

  @api_app.post("/api/project/create")
  def api_create_project(request: dict):
      result = generate_project(**request)
      return result

  ---
  五、关键技术点

  1. 动态代码生成

  系统的核心创新在于 generate_questionnaire_page_code():
  - 根据选择的内容动态生成完整的Python代码
  - 包含完整的登录、验证、保存逻辑
  - 生成的文件可以独立运行

  2. 数据流转

  FLMM调研表.xlsx → data_parser → 选择 → Excel问卷 → 动态页面 → 答案收集 → 评估结果.xlsx → 分析报告

  3. 账号管理

  - 账号密码存储在项目JSON中
  - 每个项目有独立的账号
  - 登录验证在生成的页面中实现

  4. 并发安全

  使用线程锁处理多用户同时提交:
  file_lock = threading.Lock()
  with file_lock:
      # 保存答案到Excel

  ---
  六、前端集成推荐方案总结

  | 方案          | 适用场景     | 工作量  | 优点   |
  |-------------|----------|------|------|
  | Streamlit原生 | 内部工具、POC | ⭐    | 零开发  |
  | API化分离      | 生产环境     | ⭐⭐⭐⭐ | 灵活性高 |
  | iframe嵌入    | 快速集成     | ⭐⭐   | 保留功能 |
  | 渐进迁移        | 长期规划     | ⭐⭐⭐  | 平滑过渡 |

  建议:
  - 短期: 使用Streamlit + iframe快速上线
  - 中期: 开发FastAPI层,前端调用API
  - 长期: 完全迁移到React/Vue + FastAPI架构

  需要我针对某个具体方案提供详细的实现代码吗?
