# FLMM评估问卷筛选平台

基于金融大模型应用能力评估框架(FLMM)的问卷筛选和创建工具。

## 功能特性

### 功能1：问卷筛选页面
- 支持从Excel文件读取FLMM评估数据
- 提供层次化的能力项选择界面（能力域 → 能力子域1 → 能力子域2 → 能力项）
- 支持按能力域、子域或具体能力项进行选择
- 实时显示选择结果和统计信息
- 点击"下一步"进入问卷创建页面

### 功能2：创建新问卷页面
- 输入被评估方公司名称
- 输入评估业务场景名称
- 输入评估业务场景描述
- **新增评估功能设置：**
  - 启用问卷数据收集（生成问卷采集页面）
  - 启用证明材料收集（生成证明材料上传页面）
- 自动生成或自定义登录账号密码
- 点击"确定创建"后在data文件夹下生成新的评估项目文件夹
- 根据选择生成对应的文件和页面

### 功能3：证明材料收集页面（新增）
- 基于FLMM自评表的4级树形结构选择能力项
- 支持三种上传方式：
  - 单个文件上传
  - 多个文件上传
  - 文件夹上传（ZIP压缩包）
- 支持多种文件格式：PDF、Word、PPT、Excel、图片、视频等
- 按能力项自动分类存储文件
- 实时显示已上传文件列表
- 生成上传记录JSON文件

## 数据结构

### 问卷数据（FLMM调研表.xlsx）
支持5列Excel文件格式：
- 能力域
- 能力子域1  
- 能力子域2
- 能力项
- 调研问题

### 证明材料数据（FLMM自评表.xlsx）
支持4列Excel文件格式：
- 能力域
- 能力子域1
- 能力子域2
- 能力项

## 技术实现

- **前端**: Streamlit
- **数据处理**: pandas
- **文件格式**: Excel (.xlsx)
- **导出格式**: JSON
- **架构模式**: 模块化设计
- **文件上传**: 支持ZIP解压和多文件处理

## 项目结构

```
项目根目录/
├── app.py                              # 主应用程序入口
├── function/
│   └── Admin_create_function_page.py   # 问卷创建功能模块
├── data_parser.py                      # 数据解析模块（新增FLMM自评表解析）
├── data/
│   ├── FLMM调研表.xlsx                 # 问卷基础数据文件
│   ├── FLMM自评表.xlsx                 # 证明材料基础数据文件
│   └── [公司名_场景名]/                 # 生成的评估项目文件夹
│       ├── [公司名_场景名].json         # 项目信息文件
│       ├── [公司名_场景名]_问卷.xlsx    # 问卷文件（可选）
│       ├── [公司名_场景名].py           # 问卷采集页面（可选）
│       ├── [公司名_场景名]_证明材料.py  # 证明材料收集页面（可选）
│       └── 证明材料/                    # 证明材料存储文件夹
│           ├── [能力项1]/               # 按能力项分类的文件夹
│           ├── [能力项2]/
│           └── ...
└── README.md                           # 项目说明文档
```

## 使用方法

1. 将FLMM调研表Excel文件放置在 `data/FLMM调研表.xlsx`
2. 将FLMM自评表Excel文件放置在 `data/FLMM自评表.xlsx`
3. 运行主程序：`streamlit run app.py`
4. 选择需要的评估功能（问卷收集/证明材料收集）
5. 按照界面提示完成项目创建

## 最新更新

### 2024年12月更新 - 证明材料收集功能

**新增功能：**
1. **双页面架构**：问卷收集和证明材料收集分为两个独立页面
2. **FLMM自评表解析**：支持4列结构的自评表数据解析
3. **灵活功能配置**：可选择启用问卷收集和/或证明材料收集
4. **文件分类存储**：按能力项自动创建文件夹并分类存储
5. **多种上传方式**：支持单文件、多文件、文件夹（ZIP）上传
6. **上传记录管理**：自动生成上传记录JSON文件

**技术改进：**
- 在`data_parser.py`中新增`parse_flmm_evaluation_table()`和`build_flmm_evaluation_structure()`函数
- 在`Admin_create_function_page.py`中添加证明材料收集页面生成逻辑
- 证明材料存储结构：`data/{公司名}_{场景名}/证明材料/{能力项}/`
- 支持ZIP文件自动解压功能

**文件存储结构：**
```
data/{公司名}_{场景名}/
├── {公司名}_{场景名}.json                    # 项目信息
├── {公司名}_{场景名}_问卷.xlsx               # 问卷文件（可选）
├── {公司名}_{场景名}.py                     # 问卷收集页面（可选）  
├── {公司名}_{场景名}_证明材料.py             # 证明材料收集页面（可选）
├── {公司名}_{场景名}_证明材料上传记录.json    # 上传记录
└── 证明材料/                                # 证明材料文件夹
    ├── 用户需求匹配度/                       # 能力项1文件夹
    ├── 用户目标一致性/                       # 能力项2文件夹
    └── ...                                  # 其他能力项文件夹
```

## 更新日志

### 2024-12-19
- **重要修复**：彻底修复问卷内容选择页面选择能力项后页面闪烁问题
  - 新增 `update_state_if_changed()` 辅助函数，避免无效状态更新
  - 重构了问卷选择和证明材料选择页面的状态管理逻辑
  - 修复了复选框 `value` 参数使用实时变量导致的状态不一致问题
  - 将所有依赖关系改为基于已保存的 `session_state` 而非实时变量
  - 确保 `disabled` 和 `expanded` 属性使用一致的状态源
  - 彻底解决了状态更新循环和页面重新渲染问题

- **修复**：修复问卷内容选择页面"上一步"按钮无法正常工作的问题
  - 将"上一步"按钮的目标页面从错误的 `"questionnaire_selection"` 修改为 `"company_info"`
  - 优化按钮文案为"上一步：基本信息"，提升用户体验
  - 确保页面导航逻辑的正确性和一致性
- **新增功能**：为生成的调研问卷添加登录保护机制
  - 问卷访问需要使用创建时生成的账号密码进行登录
  - 添加了完整的登录页面和用户验证逻辑
  - 登录状态会话管理，支持安全登出功能
  - 问卷结果中会记录提交用户的用户名信息
  - 单选题默认为空状态，确保用户主动选择

- **新增功能**：分析报告生成（预计算模式）
  - 在数据分析页面增加"生成分析报告"功能
  - 基于各项评级结果、子项得分和官方评级描述，通过文字拼接方式生成确定性报告
  - 报告内容包括总体评级、各维度表现、优势项和短板项分析
  - 移除了对外部大模型API的依赖，提升了稳定性和响应速度

- **界面优化**：数据分析页面布局改进
  - 各项评级模块采用每行两个图表的稳健布局
  - 评级指标标题居中显示，并统一添加"评级"后缀
  - 细分指标更名为"得分"，提升显示效果
  - 减少图表上方空白区域，布局更加紧凑

- **界面优化**：生成页面证明材料收集界面层级化改进
  - 改进生成的证明材料收集页面中的能力项选择界面
  - **第1步**：左侧显示能力域目录，用户使用单选按钮选择一个能力域
  - **第2步**：显示选中能力域下的所有能力项，按子域分组显示
  - 切换能力域时自动清空之前选择的能力项，避免跨域混乱
  - 显示当前能力域包含的能力项总数，提供更好的导航体验
  - 提升了证明材料上传时的选择效率和用户体验